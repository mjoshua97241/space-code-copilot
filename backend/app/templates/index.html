<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code-Aware Space Planning Copilot</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="app-root">
      <!-- Left Panel: Plan Viewer + Issues List -->
      <div class="left-panel">
        <div class="plan-container">
          <div class="plan-header">
            <h2>Floor Plan</h2>
          </div>
          <div class="plan-image-wrapper">
            <div class="plan-image-container">
              <img src="/static/plan.png" alt="Floor plan" id="plan-image" />
              <div class="overlays-container" id="overlays-container"></div>
            </div>
          </div>
        </div>
        <div class="issues-panel">
          <div class="issues-header">
            <h3>Compliance Issues</h3>
            <span class="issues-count" id="issues-count">Loading...</span>
          </div>
          <div class="issues-list" id="issues-list">
            <div class="loading">Loading issues...</div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Chat -->
      <div class="right-panel">
        <div class="chat-header">
          <h3>Building Code Assistant</h3>
          <p class="chat-subtitle">Ask questions about building codes and compliance</p>
        </div>
        <div class="chat-messages" id="chat-messages">
          <div class="welcome-message">
            <p>üëã Welcome! I can help you understand building code requirements and compliance issues.</p>
            <p>Try asking:</p>
            <ul>
              <li>"What is the minimum bedroom area?"</li>
              <li>"What are the door width requirements?"</li>
              <li>"Explain the accessible door requirements"</li>
            </ul>
          </div>
        </div>
        <div class="chat-input">
          <form id="chat-form">
            <textarea
              id="chat-input"
              placeholder="Ask about building codes or compliance issues..."
              rows="3"
            ></textarea>
            <div class="chat-actions">
              <button type="submit" id="chat-submit-btn">
                <span class="btn-text">Send</span>
                <span class="btn-loading" style="display: none;">Sending...</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // ====================================================================
      // State Management
      // ====================================================================
      let selectedIssueId = null;
      let issues = [];
      let overlays = [];
      let overlayElements = new Map(); // Map of element_id -> overlay DOM element

      // ====================================================================
      // Issues Fetching and Rendering
      // ====================================================================

      async function fetchIssues() {
        const listContainer = document.getElementById("issues-list");
        const countElement = document.getElementById("issues-count");
        
        listContainer.innerHTML = '<div class="loading">Loading issues...</div>';
        countElement.textContent = "Loading...";

        try {
          const res = await fetch("/api/issues");
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          issues = await res.json();
          
          // Update count
          countElement.textContent = `${issues.length} issue${issues.length !== 1 ? 's' : ''}`;
          
          if (issues.length === 0) {
            listContainer.innerHTML = '<div class="no-issues">‚úÖ No compliance issues found. Design is compliant!</div>';
            return;
          }

          // Render issues
          listContainer.innerHTML = "";
          issues.forEach((issue) => {
            const issueElement = createIssueElement(issue);
            listContainer.appendChild(issueElement);
          });
        } catch (e) {
          console.error("Error fetching issues:", e);
          listContainer.innerHTML = `<div class="error">Failed to load issues: ${e.message}</div>`;
          countElement.textContent = "Error";
        }
      }

      function createIssueElement(issue) {
        const div = document.createElement("div");
        div.className = "issue-item";
        div.dataset.issueId = `${issue.element_type}-${issue.element_id}`;
        
        // Add click handler for selection
        div.addEventListener("click", () => {
          selectIssue(issue);
        });

        // Severity badge
        const severityClass = issue.severity === "warning" ? "severity-warning" : "severity-error";
        const severityText = issue.severity === "warning" ? "‚ö† Warning" : "‚ùå Error";

        div.innerHTML = `
          <div class="issue-header">
            <span class="issue-id">${issue.element_type.toUpperCase()} ${issue.element_id}</span>
            <span class="severity-badge ${severityClass}">${severityText}</span>
          </div>
          <div class="issue-message">${escapeHtml(issue.message)}</div>
          ${issue.code_ref ? `<div class="issue-code-ref">üìã ${escapeHtml(issue.code_ref)}</div>` : ""}
          <div class="issue-rule">Rule: ${escapeHtml(issue.rule_id)}</div>
        `;

        return div;
      }

      function selectIssue(issue) {
        // Remove previous selection
        document.querySelectorAll(".issue-item").forEach(item => {
          item.classList.remove("selected");
        });

        // Remove previous overlay highlights
        document.querySelectorAll(".overlay").forEach(overlay => {
          overlay.classList.remove("highlighted");
        });

        // Add selection to clicked issue
        const issueElement = document.querySelector(
          `.issue-item[data-issue-id="${issue.element_type}-${issue.element_id}"]`
        );
        if (issueElement) {
          issueElement.classList.add("selected");
          selectedIssueId = `${issue.element_type}-${issue.element_id}`;
        }

        // Highlight corresponding overlay on plan image
        const overlayElement = overlayElements.get(issue.element_id);
        if (overlayElement) {
          overlayElement.classList.add("highlighted");
          // Scroll overlay into view if needed
          overlayElement.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
        }
      }

      // ====================================================================
      // Chat Functionality
      // ====================================================================

      async function sendChat(query) {
        const messagesContainer = document.getElementById("chat-messages");
        const submitBtn = document.getElementById("chat-submit-btn");
        const input = document.getElementById("chat-input");

        // Remove welcome message if present
        const welcomeMsg = messagesContainer.querySelector(".welcome-message");
        if (welcomeMsg) {
          welcomeMsg.remove();
        }

        // Add user message
        const userMessageDiv = createUserMessage(query);
        messagesContainer.appendChild(userMessageDiv);
        scrollChatToBottom();

        // Disable input and show loading
        input.disabled = true;
        submitBtn.disabled = true;
        submitBtn.querySelector(".btn-text").style.display = "none";
        submitBtn.querySelector(".btn-loading").style.display = "inline";

        // Add loading message
        const loadingDiv = createLoadingMessage();
        messagesContainer.appendChild(loadingDiv);
        scrollChatToBottom();

        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: query }),
          });

          // Remove loading message
          loadingDiv.remove();

          if (!res.ok) {
            const errorData = await res.json().catch(() => ({ detail: `HTTP ${res.status}` }));
            throw new Error(errorData.detail || `HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();
          
          // Add bot response with citations
          const botMessageDiv = createBotMessage(data.answer, data.citations || []);
          messagesContainer.appendChild(botMessageDiv);
          scrollChatToBottom();
        } catch (e) {
          console.error("Error sending chat:", e);
          loadingDiv.remove();
          const errorDiv = createErrorMessage(e.message);
          messagesContainer.appendChild(errorDiv);
          scrollChatToBottom();
        } finally {
          // Re-enable input
          input.disabled = false;
          submitBtn.disabled = false;
          submitBtn.querySelector(".btn-text").style.display = "inline";
          submitBtn.querySelector(".btn-loading").style.display = "none";
        }
      }

      function createUserMessage(text) {
        const div = document.createElement("div");
        div.className = "message message-user";
        div.innerHTML = `
          <div class="message-content">
            <div class="message-text">${escapeHtml(text)}</div>
          </div>
        `;
        return div;
      }

      function createBotMessage(answer, citations) {
        const div = document.createElement("div");
        div.className = "message message-bot";
        
        let citationsHtml = "";
        if (citations && citations.length > 0) {
          citationsHtml = `
            <div class="citations">
              <div class="citations-header">üìö Sources:</div>
              ${citations.map(citation => `
                <div class="citation-item">
                  <strong>${escapeHtml(citation.source || "Unknown")}</strong>
                  ${citation.page ? `, Page ${citation.page}` : ""}
                  ${citation.section ? `, Section ${escapeHtml(citation.section)}` : ""}
                </div>
              `).join("")}
            </div>
          `;
        }

        div.innerHTML = `
          <div class="message-content">
            <div class="message-text">${formatAnswer(answer)}</div>
            ${citationsHtml}
          </div>
        `;
        return div;
      }

      function createLoadingMessage() {
        const div = document.createElement("div");
        div.className = "message message-bot message-loading";
        div.innerHTML = `
          <div class="message-content">
            <div class="message-text">
              <span class="loading-dots">
                <span>.</span><span>.</span><span>.</span>
              </span>
            </div>
          </div>
        `;
        return div;
      }

      function createErrorMessage(errorMessage) {
        const div = document.createElement("div");
        div.className = "message message-bot message-error";
        div.innerHTML = `
          <div class="message-content">
            <div class="message-text">
              ‚ùå Error: ${escapeHtml(errorMessage)}
            </div>
          </div>
        `;
        return div;
      }

      function formatAnswer(text) {
        // Basic formatting: preserve line breaks and format citations
        return escapeHtml(text)
          .replace(/\n/g, "<br>")
          .replace(/\[Source: ([^\]]+)\]/g, '<span class="inline-citation">[Source: $1]</span>');
      }

      function scrollChatToBottom() {
        const messagesContainer = document.getElementById("chat-messages");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // ====================================================================
      // Overlay Loading and Rendering
      // ====================================================================

      async function loadOverlays() {
        try {
          const res = await fetch("/static/overlays.json");
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          overlays = await res.json();
          renderOverlays();
        } catch (e) {
          console.error("Error loading overlays:", e);
          // Silently fail - overlays are optional
        }
      }

      function renderOverlays() {
        const container = document.getElementById("overlays-container");
        const planImage = document.getElementById("plan-image");
        
        if (!container || !planImage || overlays.length === 0) {
          return;
        }

        // Wait for image to load to get actual dimensions
        if (planImage.complete) {
          renderOverlayElements();
        } else {
          planImage.addEventListener("load", renderOverlayElements, { once: true });
        }
        
        // Update overlay positions on window resize
        window.addEventListener("resize", handleResize);
      }

      function renderOverlayElements() {
        const container = document.getElementById("overlays-container");
        const planImage = document.getElementById("plan-image");
        const imageContainer = planImage?.parentElement;
        
        if (!container || !planImage || !imageContainer) {
          return;
        }

        // Clear existing overlays
        container.innerHTML = "";
        overlayElements.clear();

        // Get image dimensions
        const imgRect = planImage.getBoundingClientRect();
        const containerRect = imageContainer.getBoundingClientRect();
        const imgNaturalWidth = planImage.naturalWidth;
        const imgNaturalHeight = planImage.naturalHeight;
        
        // Calculate scale factor if image is scaled
        const scaleX = imgRect.width / imgNaturalWidth;
        const scaleY = imgRect.height / imgNaturalHeight;
        
        // Calculate offset if image is centered within container
        const offsetX = imgRect.left - containerRect.left;
        const offsetY = imgRect.top - containerRect.top;
        
        // Position overlay container to match image
        container.style.left = `${offsetX}px`;
        container.style.top = `${offsetY}px`;
        container.style.width = `${imgRect.width}px`;
        container.style.height = `${imgRect.height}px`;

        // Create overlay elements
        overlays.forEach((overlay) => {
          const overlayDiv = document.createElement("div");
          overlayDiv.className = "overlay";
          overlayDiv.dataset.elementId = overlay.id;
          overlayDiv.dataset.elementType = overlay.type;
          
          // Calculate scaled position and size (relative to overlay container)
          const x = overlay.x * scaleX;
          const y = overlay.y * scaleY;
          const width = overlay.width * scaleX;
          const height = overlay.height * scaleY;
          
          overlayDiv.style.left = `${x}px`;
          overlayDiv.style.top = `${y}px`;
          overlayDiv.style.width = `${width}px`;
          overlayDiv.style.height = `${height}px`;
          
          // Store reference for highlighting
          overlayElements.set(overlay.id, overlayDiv);
          
          container.appendChild(overlayDiv);
        });
      }
      
      // Throttled resize handler
      let resizeTimeout;
      function handleResize() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          renderOverlayElements();
        }, 100);
      }

      // ====================================================================
      // Utility Functions
      // ====================================================================

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // ====================================================================
      // Event Listeners
      // ====================================================================

      document.addEventListener("DOMContentLoaded", () => {
        // Load overlays on page load
        loadOverlays();
        
        // Fetch issues on page load
        fetchIssues();

        // Chat form submission
        const form = document.getElementById("chat-form");
        const input = document.getElementById("chat-input");
        
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const text = input.value.trim();
          if (!text) return;
          input.value = "";
          sendChat(text);
        });

        // Allow Enter to submit (Shift+Enter for new line)
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event("submit"));
          }
        });
      });
    </script>
  </body>
</html>
